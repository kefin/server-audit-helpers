#!/bin/sh
#
# helper functions for audit scripts
#
# * created: 2012-02-05 Kevin Chan <kefin@makedostudio.com>
# * updated: 2012-02-11 kchan

########################################################################
myname=`basename $0`
OLD_PWD=$PWD
cd "`dirname $0`"
mydir="${PWD%/}"
cd "$OLD_PWD"
########################################################################


########################################################################
# helper functions
########################################################################

error()
{
    [ "$1" ] && echo >&2 "###" "$@"
    exit 1
}

check_file()
{
    [ ! -f "$1" ] && error "$myname - cannot find file: $1"
}

makedir()
{
    [ "$1" ] && {
        [ ! -d "$1" ] && mkdir -p "$1"
    }
}

check_root_user()
{
    [ $(id -u) != 0 ] && error "Script must be run by root."
}

# notify script is part of the backup-scripts package
NOTIFY="/usr/local/bin/notify"
MAIL="$(which mail)"

notify()
{
    email="$1"
    subject="$2"
    msgfile="$3"
    if [ -x "$NOTIFY" ]; then
        "$NOTIFY" -s "$subject" -f "$msgfile" "$email"
    else
        cat "$msgfile" | "$MAIL" -s "$subject" "$email"
    fi
}

# function to execute command and send results by email
# parameters:
# * command_name
# * command(s)

DEFAULT_LOG_DIR="/var/log"

run_tool()
{
    command_name="$1"
    command="$2"

    if [ "X$LOG_DIR" != "X" ]; then
        log_dir="$LOG_DIR"
    else
        log_dir="${DEFAULT_LOG_DIR}/${command_name}"
    fi
    log_dir="${log_dir%/}"
    makedir "$log_dir"

    output_file="$log_dir/${command_name}_$(date '+%Y-%m-%d').log"

    {
        echo "# Start  : $(date '+%Y-%m-%d %H:%M:%S')"
        echo
        if [ "X$command" != "X" ]; then
            $command
        else
            echo "No command to run."
        fi
        echo
        echo "# Finish : $(date '+%Y-%m-%d %H:%M:%S')"
    } >"$output_file" 2>&1

    if [ "X$EMAIL" != "X" ]; then
        if [ "X$SUBJECT" != "X" ]; then
            subject="$SUBJECT - ${command_name} output"
        else
            subject="${command_name} output"
        fi
        for email in $EMAIL
        do
            notify "$email" "$(date '+%Y-%m-%d') $subject" "$output_file"
        done
    fi
}

########################################################################

