#!/bin/sh
#
# utils
#
# helper functions for audit scripts
#
# * created: 2012-02-05 Kevin Chan <kefin@makedostudio.com>
# * updated: 2012-07-08 kchan

########################################################################
myname=$(basename "$0")
OLD_PWD=$PWD
cd $(dirname "$0")
mydir=${PWD%/}
cd "$OLD_PWD"
########################################################################


########################################################################
# helper functions

error()
{
    [ "$1" ] && echo >&2 "###" "$@"
    exit 1
}

check_file()
{
    [ ! -f "$1" ] && error "$myname - cannot find file: $1"
}

makedir()
{
    [ "$1" ] && [ ! -d "$1" ] && mkdir -p "$1"
}

check_root_user()
{
    [ $(id -u) != 0 ] && error "Script must be run by root."
}

# notify script is part of the backup-scripts package
NOTIFY="/usr/local/bin/notify"
MAIL="$(which mail)"

notify()
{
    local email="$1"
    local subject="$2"
    local msgfile="$3"
    if [ -x "$NOTIFY" ]; then
        "$NOTIFY" -s "$subject" -f "$msgfile" "$email"
    else
        cat "$msgfile" | "$MAIL" -s "$subject" "$email"
    fi
}

# function to execute command and send results by email
# parameters:
# * command_name
# * command(s)

DIVIDER="########################################################################"
DEFAULT_LOG_DIR="/var/log/audit"

run_tool()
{
    local command_name="$1"
    local command="$2"
    local log_dir=
    local subject=

    if [ "X$LOG_DIR" != "X" ]; then
        log_dir="$LOG_DIR"
    else
        log_dir="${DEFAULT_LOG_DIR}/${command_name}"
    fi
    log_dir="${log_dir%/}"
    makedir "$log_dir"

    #local output_file="$log_dir/${command_name}_$(date '+%Y-%m-%d').log"
    local output_file="$log_dir/${command_name}.log"

    {
        echo $DIVIDER
        echo "# Start  : $(date '+%Y-%m-%d %H:%M:%S')"
        echo
        if [ "X$command" != "X" ]; then
            $command
        else
            echo "No command to run."
        fi
        echo
        echo "# Finish : $(date '+%Y-%m-%d %H:%M:%S')"
        echo $DIVIDER
        echo
    } >"$output_file" 2>&1

    if [ "X$EMAIL" != "X" ]; then
        if [ "X$SUBJECT" != "X" ]; then
            subject="$SUBJECT - ${command_name} output"
        else
            subject="${command_name} output"
        fi
        for email in $EMAIL
        do
            notify "$email" "$(date '+%Y-%m-%d') $subject" "$output_file"
        done
    fi
}
