#!/bin/sh
#
# script run audit tools and email results to sysadmin
#
# * created: 2011-05-22 Kevin Chan <kefin@makedostudio.com>
# * updated: 2012-02-11 kchan
#
# Add to crontab to run script at regular intervals
#
# crontab entry to run backup every night @ midnight
# 0 0 * * * /usr/local/audit/bin/run_audit >> /dev/null 2>&1

########################################################################
myname=`basename $0`
OLD_PWD=$PWD
cd "`dirname $0`"
mydir="${PWD%/}"
cd "$OLD_PWD"
########################################################################

errors=0

### run audit sub-scripts

# function to test if sub-script exists and is executable

is_executable()
{
    script="$1"
    [ ! -x "$script" ] && return 0
    basename=$(basename "$script")
    case "$basename" in
        $myname)
            return 0
            ;;
        utils)
            return 0
            ;;
        *~)
            return 0
            ;;
        *)
            return 1
            ;;
    esac
}

# function to run sub-script

run_script()
{
    script="$1"
    echo >&2 "# running $script ..."
    "$script" || $((errors + 1))
    echo >&2 "# done."
}


if [ $# -gt 0 ]; then

    # loop through scripts provided as parameters if these exist
    for script in "$@"
    do
        script="$mydir/$script"
        is_executable "$script"
        [ $? -eq 1 ] && run_script "$script"
    done

else

    # loop through scripts in audit bin directory if no parameters
    for script in $(find "$mydir" -type f -print | sort)
    do
        is_executable "$script"
        [ $? -eq 1 ] && run_script "$script"
    done

fi

[ "$errors" -eq 0 ] && status=0 || status=1

exit $status

