#!/bin/sh
#
# run_audit
#
# script to run audit tools and email reports to sysadmin
#
# * created: 2011-05-22 Kevin Chan <kefin@makedostudio.com>
# * updated: 2012-07-08 kchan
#
# Add to crontab to run script at regular intervals:
#
# crontab entry to run backup every night @ midnight
# 0 0 * * * /usr/local/audit/bin/run_audit >> /dev/null 2>&1

########################################################################
myname=$(basename "$0")
OLD_PWD=$PWD
cd $(dirname "$0")
mydir=${PWD%/}
cd "$OLD_PWD"
########################################################################

errors=0

### run audit sub-scripts

# error function

exec_error()
{
    echo "# not an executable audit script: $1" >&2
    $((errors + 1))
}

# functions to test if sub-script exists and is executable
# * is_executable does minimal filtering and checks if script
#   is executable
# * is_audit_script checks if script is executable and is
#   not a backup or utils or dummy.

is_executable()
{
    local script="$1"
    [ -x "$script" ] || echo 0
    case $(basename "$script") in
        $myname|utils)
            echo 0
            ;;
        *)
            echo 1
            ;;
    esac
}

is_audit_script()
{
    local script="$1"
    [ -x "$script" ] || echo 0
    case $(basename "$script") in
        $myname|utils|dummy|*~)
            echo 0
            ;;
        *)
            echo 1
            ;;
    esac
}

# function to run sub-script

run_script()
{
    local script="$1"
    echo >&2 "# running $script ..."
    "$script" || $((errors + 1))
    echo >&2 "# done."
}


if [ $# -gt 0 ]; then

    # loop through scripts provided as parameters if these exist
    # * for scripts supplied on the command line we do minimal
    #   filtering and execute it if it has the executable bit set.
    for script in "$@"
    do
        script="${mydir}/${script}"
        [ $(is_executable "$script") -eq 1 ] \
            && run_script "$script" \
            || exec_error "$script"
    done

else

    # loop through scripts in audit bin directory if no parameters
    for script in $(find "$mydir" -type f -print | sort)
    do
        [ $(is_audit_script "$script") -eq 1 ] && run_script "$script"
    done

fi

[ "$errors" -eq 0 ] && status=0 || status=1

exit $status
