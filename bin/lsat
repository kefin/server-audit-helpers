#!/bin/sh
#
# wrapper sub-script to run security tool
#
# * created: 2012-02-05 Kevin Chan <kefin@makedostudio.com>
# * updated: 2014-11-01 kchan

########################################################################
myname="${0##*/}"
current_wd=$PWD
cd $(dirname "$0")
mydir="${PWD%/}"
cd "$current_wd"
########################################################################

PATH=/usr/local/sbin:/usr/sbin:/usr/bin:/sbin:/bin:/root/bin

# load configurations and helper functions

BASE_DIR="$(dirname $mydir)"
CONFIG_DIR="/etc/audit"
CONFIG="${CONFIG_DIR}/run_audit.conf"
UTILS="${BASE_DIR}/bin/utils"

. "$CONFIG"
. "$UTILS"

check_root_user

# run lsat audit

LSAT=$(which lsat || echo "")
LOGFILE="${LOG_DIR:-/var/log/audit}/lsat.out"

DIVIDER="########################################################################"

run_lsat()
{
    if "$LSAT" -o "$LOGFILE"; then
        if [ -f "$LOGFILE" ]; then
            echo
            echo "$DIVIDER"
            cat "$LOGFILE"
            echo "$DIVIDER"
            return 0
        fi
    fi
    return 1
}

makedir "$(dirname $LOGFILE)"

if [ "X$LSAT" != "X" ] && [ -x "$LSAT" ]; then
    run_tool "lsat" "run_lsat" || exit 1
else
    error "unable to execute command: lsat"
fi
